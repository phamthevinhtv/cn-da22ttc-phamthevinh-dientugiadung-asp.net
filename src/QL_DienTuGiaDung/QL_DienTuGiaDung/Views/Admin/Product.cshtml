@using System.Globalization
@model List<SanPham>
@{
    ViewData["HideSidebar"] = false;
    ViewData["SidebarName"] = "_SidebarAdmin";
    ViewData["SidebarType"] = "PartialView";
    var message = TempData["Message"] as string;
    var error = TempData["Error"] as string;
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin.css" asp-append-version="true"/>
}

<div class="admin-product-wrapper">
    <div class="admin-product-tool" style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 6px;">
            <form asp-action="Product" asp-controller="Admin" method="get" style="display: flex; flex: 1; gap: 6px;">
                <input type="hidden" name="productTypeId" value="@ViewBag.CurrentProductTypeId" />
                <input type="text" name="searchTerm" class="input" style="min-width: 170px;" placeholder="Tìm kiếm sản phẩm" required value="@ViewBag.SearchTerm" />
                <button type="submit" class="button">Tìm</button>
                @if (!string.IsNullOrEmpty(ViewBag.SearchTerm))
                {
                    <a href="@Url.Action("Product", "Admin", new { productTypeId = ViewBag.CurrentProductTypeId })" class="button" style="min-width: fit-content; background-color: #c8c8c8; border-color: #ebf0f5; color: var(--color-text-normal)">Đặt lại</a>
                }
            </form>
            <select class="select" style="width: fit-content;" id="productFilterSelect" onchange="redirectToFilter()">
                <option value="@Url.Action("Product", "Admin", new { searchTerm = ViewBag.SearchTerm })" selected="@(ViewBag.CurrentProductTypeId == 0)">Tất cả sản phẩm</option>
                @if (ViewBag.ProductTypes != null)
                {
                    @foreach (var item in (List<LoaiSanPham>)ViewBag.ProductTypes)
                    {
                        <option value="@Url.Action("Product", "Admin", new { productTypeId = item.MaLSP, searchTerm = ViewBag.SearchTerm })" selected="@(ViewBag.CurrentProductTypeId == item.MaLSP)">@item.TenLSP</option>
                    }
                }
            </select>
            <select class="select" style="width: fit-content;" id="productAddSelect" onchange="redirectToAddProduct()">
                <option value="" style="text-align: center;">Thêm sản phẩm</option>
                @if (ViewBag.ProductTypes != null)
                {
                    @foreach (var item in (List<LoaiSanPham>)ViewBag.ProductTypes)
                    {
                        <option value="@Url.Action("ProductDetail", "Admin", new { productTypeId = item.MaLSP })">@item.TenLSP</option>
                    }
                }
            </select>
        </div>

        <script>
            function redirectToFilter() {
                var select = document.getElementById('productFilterSelect');
                var url = select.value;
                if (url) {
                    window.location.href = url;
                }
            }
            
            function redirectToAddProduct() {
                var select = document.getElementById('productAddSelect');
                var url = select.value;
                if (url) {
                    window.location.href = url;
                }
            }
        </script>
</div>
<div class="admin-product-wrapper">
    @if (Model.Count > 0)
    {
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tên sản phẩm</th>
                    <th>Giá nhập</th>
                    <th>Giá niêm yết</th>
                    <th>Số lượng</th>
                    <th>Trạng thái</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in Model)
                { 
                    <tr>
                        <td>@product.MaSP</td>
                        <td>
                            <div class="inline">
                                <img src="@(string.IsNullOrWhiteSpace(product.UrlAnh) ? "/images/no_img.png" : product.UrlAnh)" alt="Ảnh sản phẩm">
                                @product.TenSP
                            </div>
                        </td>
                        <td>@product.GiaNhapSP.ToString("N0", new CultureInfo("vi-VN"))</td>
                        <td>@product.GiaGocSP.ToString("N0", new CultureInfo("vi-VN"))</td>
                        <td>@product.SoLuongSP</td>
                        <td>
                            <span class="status @(product.TrangThaiSP == 1 ? "status-active" : "status-inactive")">@(product.TrangThaiSP == 1 ? "Đang bán" : "Dừng bán")</span>
                        </td>
                        <td>
                            <div class="actions">
                                <a asp-action="ProductDetail" asp-controller="Admin" asp-route-productId="@product.MaSP" asp-route-productTypeId="@product.MaLSP" class="button button-edit">Sửa</a>
                                @{
                                    var canDeleteProducts = ViewBag.CanDeleteProducts as Dictionary<int, bool>;
                                    bool canDelete = canDeleteProducts?.ContainsKey(product.MaSP) == true && canDeleteProducts[product.MaSP];
                                }
                                @if (canDelete)
                                {
                                    <form asp-action="DeleteProduct" asp-controller="Admin" method="post" style="display: inline;" 
                                          onsubmit="return confirm('Bạn có chắc muốn xóa sản phẩm này? Thao tác này không thể hoàn tác!')">
                                        <input type="hidden" name="productId" value="@product.MaSP" />
                                        <input type="hidden" name="productTypeId" value="@product.MaLSP" />
                                        <button type="submit" class="button button-delete">Xóa</button>
                                    </form>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        @if (!string.IsNullOrEmpty(ViewBag.SearchTerm))
        {
            <p>Không tìm thấy sản phẩm nào với từ khóa "<strong>@ViewBag.SearchTerm</strong>"</p>
        }
        else
        {
            <p>Danh sách sản phẩm hiện đang trống</p>
        }
    }
</div>

@if (!string.IsNullOrEmpty(message))
{
    <script>
        alert('@Html.Raw(message)');
    </script>
}

@if (!string.IsNullOrEmpty(error))
{
    <script>
        alert('@Html.Raw(error)');
    </script>
}